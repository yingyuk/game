"use strict";function game(){init(),lastTime=Date.now(),gameloop()}function gameloop(){window.requestAnimFrame(gameloop),updateTime(),drawBackground(),anemone.draw(),fruit.draw(),dust.draw(),ctxFish.clearRect(0,0,canWidth,canHeight),mom.draw(),baby.draw(),CollectionFruit(),momBabyCollision(),data.draw(),wave.draw(),halo.draw()}function init(){CanvasInit(),anemone=new AneObj,fruit=new FruitObj,mom=new MomObj,baby=new BabyObj,data=new DataObj,wave=new WaveObj,halo=new WaveObj({color:"203,91,0",maxRadius:100}),dust=new DustObj}function onMouseMove(t){data.gameOver||(t.offsetX||t.layerX)&&(mouseX=void 0==t.offsetX?t.layerX:t.offsetX,mouseY=void 0==t.offsetY?t.layerY:t.offsetY)}function extend(t,i){for(var e in i)void 0==t[e]&&(t[e]=i[e])}function updateTime(){nowTime=Date.now(),deltaTime=nowTime-lastTime,deltaTime=deltaTime>50?50:deltaTime,lastTime=nowTime}function lerpDistance(t,i,e){var a=i-t;return t+a*e}function lerpAngle(t,i,e){var a=i-t;return a>Math.PI&&(a-=2*Math.PI),a<-Math.PI&&(a+=2*Math.PI),t+a*e}function drawBackground(){ctxBg.drawImage(bgPic,0,0,canWidth,canHeight,0,0,800,600)}function Background(t){extend(this,t),this.pic=new Image}function CanvasInit(){canFish=document.getElementById("canvasFish"),ctxFish=canFish.getContext("2d"),canBg=document.getElementById("canvasBg"),ctxBg=canBg.getContext("2d"),canWidth=canBg.width,canHeight=canBg.height,mouseX=canWidth/2,mouseY=canHeight/2,canFish.addEventListener("mousemove",onMouseMove,!1),ctxFish.font="20px arial",ctxFish.textAlign="center",ctxFish.fillStyle="white"}function FruitObj(){this.alive=[],this.mature=[],this.orange=new Image,this.blue=new Image,this.x=[],this.y=[],this.speed=[],this.radius=[],this.pic=[],this.fruitType=[],this.index=[],this.init()}function AneObj(){this.startPointX=[],this.startPointX=[],this.startPointY=canHeight,this.endPointX=[],this.endPointY=[],this.alpha=0,this.amplitude=[],this.sinc=0,this.init()}function CollectionFruit(){if(!data.gameOver)for(var t=0;t<fruit.num;t++)if(fruit.alive[t]&&fruit.mature[t]){var i=calLength2(fruit.x[t],fruit.y[t],mom.x,mom.y);i<900&&(fruit.dead(t),wave.born(fruit.x[t],fruit.y[t]),data.fruitNum++,mom.momBodyIndex<7&&mom.momBodyIndex++,"blue"==fruit.fruitType[t]&&(data["double"]=2))}}function momBabyCollision(){if(!data.gameOver&&data.fruitNum>0){var t=calLength2(baby.x,baby.y,mom.x,mom.y);t<900&&(mom.momBodyIndex=0,baby.babyBodyIndex=0,data.addScore(),halo.born(baby.x,baby.y))}}function calLength2(t,i,e,a){return Math.pow(t-e,2)+Math.pow(i-a,2)}function WaveObj(t){extend(this,t),this.x=[],this.y=[],this.alive=[],this.radius=[],this.maxRadius=this.maxRadius||50,this.color=this.color||"255,255,255"}var canFish,canBg,canWidth,canHeight,ctxFish,ctxBg,lastTime,deltaTime,nowTime,anemone,fruit,mom,baby,mouseX,mouseY,babyTailArr=[],babyEyeArr=[],babyBodyArr=[],data,momTailArr=[],momEyeArr=[],momBodyArr=[],momBodyOrange=[],momBodyBlue=[],wave,halo,dust,dustPicArr=[],bgPic=new Image;bgPic.src="./images/background.jpg",bgPic.onload=game,window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){return window.setTimeout(t,1e3/60)}}(),extend(Background.prototype,{init:function(){this.pic.src="./images/background.jpg"},draw:function(){ctxBg.drawImage(bgPic,0,0,canWidth,canHeight,0,0,800,600)}});var MomObj=function(){this.x,this.y,this.momTailTimer=0,this.momTailIndex=0,this.momEyeTimer=0,this.momEyeIndex=0,this.momEyeInterval=1e3,this.momBodyIndex=0,this.deltaX,this.deltaY,this.beta,this.angle=0,this.init()};MomObj.prototype={constructor:MomObj,init:function(){this.x=canWidth/2,this.y=canHeight/2;for(var t=0;t<8;t++)momTailArr[t]=new Image,momTailArr[t].src="./images/bigFish/bigTail"+t+".png";for(var t=0;t<2;t++)momEyeArr[t]=new Image,momEyeArr[t].src="./images/bigFish/bigEye"+t+".png";for(var t=0;t<8;t++)momBodyOrange[t]=new Image,momBodyBlue[t]=new Image,momBodyOrange[t].src="./images/bigFish/bigSwim"+t+".png",momBodyBlue[t].src="./images/bigFish/bigSwimBlue"+t+".png"},draw:function(){this.x=lerpDistance(this.x,mouseX,.03),this.y=lerpDistance(this.y,mouseY,.03),this.deltaX=mouseX-this.x,this.deltaY=mouseY-this.y,this.beta=Math.atan2(this.deltaY,this.deltaX)+Math.PI,this.angle=lerpAngle(this.beta,this.angle,.6),this.momTailTimer+=deltaTime,this.momTailTimer>180&&(this.momTailIndex=(this.momTailIndex+1)%8,this.momTailTimer%=50),this.momEyeTimer+=deltaTime,this.momEyeTimer>this.momEyeInterval&&(this.momEyeIndex=(this.momEyeIndex+1)%2,this.momEyeTimer%=this.momEyeInterval,0==this.momEyeIndex?this.momEyeInterval=2e3*Math.random()+500:this.momEyeInterval=500),ctxFish.save(),ctxFish.translate(this.x,this.y),ctxFish.rotate(this.angle),2==data["double"]?ctxFish.drawImage(momBodyOrange[this.momBodyIndex],momBodyOrange[this.momBodyIndex].width/-2,momBodyOrange[this.momBodyIndex].height/-2):ctxFish.drawImage(momBodyBlue[this.momBodyIndex],momBodyOrange[this.momBodyIndex].width/-2,momBodyOrange[this.momBodyIndex].height/-2),ctxFish.drawImage(momTailArr[this.momTailIndex],momTailArr[this.momTailIndex].width/-2+35,momTailArr[this.momTailIndex].height/-2),ctxFish.drawImage(momEyeArr[this.momEyeIndex],momEyeArr[this.momEyeIndex].width/-2,momEyeArr[this.momEyeIndex].height/-2),ctxFish.restore()}};var BabyObj=function(){this.x,this.y,this.babyTailTimer=0,this.babyTailIndex=0,this.babyEyeTimer=0,this.babyEyeIndex=0,this.babyEyeInterval=1e3,this.babyBodyTimer=0,this.babyBodyIndex=0,this.babyBodyInterval=1e3,this.deltaX,this.deltaY,this.beta,this.angle=0,this.init()};BabyObj.prototype={constructor:BabyObj,init:function(){this.x=canWidth/2,this.y=canHeight/2;for(var t=0;t<8;t++)babyTailArr[t]=new Image,babyTailArr[t].src="./images/babyFish/babyTail"+t+".png";for(var t=0;t<2;t++)babyEyeArr[t]=new Image,babyEyeArr[t].src="./images/babyFish/babyEye"+t+".png";for(var t=0;t<20;t++)babyBodyArr[t]=new Image,babyBodyArr[t].src="./images/babyFish/babyFade"+t+".png"},draw:function(){this.x=lerpDistance(this.x,mom.x,.03),this.y=lerpDistance(this.y,mom.y,.03),this.deltaX=mom.x-this.x,this.deltaY=mom.y-this.y,this.beta=Math.atan2(this.deltaY,this.deltaX)+Math.PI,this.angle=lerpAngle(this.beta,this.angle,.6),this.babyTailTimer+=deltaTime,this.babyTailTimer>180&&(this.babyTailIndex=(this.babyTailIndex+1)%8,this.babyTailTimer%=50),this.babyEyeTimer+=deltaTime,this.babyEyeTimer>this.babyEyeInterval&&(this.babyEyeIndex=(this.babyEyeIndex+1)%2,this.babyEyeTimer%=this.babyEyeInterval,0==this.babyEyeIndex?this.babyEyeInterval=2e3*Math.random()+500:this.babyEyeInterval=500),this.babyBodyTimer+=deltaTime,this.babyBodyTimer>300&&(this.babyBodyIndex<19?this.babyBodyIndex=this.babyBodyIndex+1:data.gameOver=!0,this.babyBodyTimer%=300),ctxFish.save(),ctxFish.translate(this.x,this.y),ctxFish.rotate(this.angle),ctxFish.drawImage(babyBodyArr[this.babyBodyIndex],babyBodyArr[this.babyBodyIndex].width/-2,babyBodyArr[this.babyBodyIndex].height/-2),ctxFish.drawImage(babyTailArr[this.babyTailIndex],babyTailArr[this.babyTailIndex].width/-2+30,babyTailArr[this.babyTailIndex].height/-2),ctxFish.drawImage(babyEyeArr[this.babyEyeIndex],babyEyeArr[this.babyEyeIndex].width/-2+2,babyEyeArr[this.babyEyeIndex].height/-2),ctxFish.restore()}},FruitObj.prototype={constructor:FruitObj,num:30,init:function(){for(var t=0;t<this.num;t++)this.alive[t]=!1,this.mature[t]=!1,this.x[t]=0,this.y[t]=0,this.radius[t]=0,this.speed[t]=.01*Math.random()+.005,this.check();this.orange.src="./images/fruit.png",this.blue.src="./images/blue.png"},draw:function(){for(var t=0;t<this.num;t++)this.alive[t]&&(this.radius[t]<14?(this.radius[t]+=this.speed[t]*deltaTime,this.x[t]=anemone.endPointX[this.index[t]],this.y[t]=anemone.endPointY[this.index[t]]):(this.y[t]-=7*this.speed[t]*deltaTime,this.mature[t]=!0),ctxBg.drawImage(this.pic[t],this.x[t]-.5*this.radius[t],this.y[t]-.5*this.radius[t],this.radius[t],this.radius[t]),this.y[t]<10&&(this.alive[t]=!1));this.check()},born:function(t){this.index[t]=Math.floor(Math.random()*anemone.num),this.x[t]=anemone.startPointX[this.index[t]],this.y[t]=canHeight-anemone.endPointY[this.index[t]],this.radius[t]=0,this.alive[t]=!0,this.mature[t]=!1;var i=Math.random();i<.7?(this.pic[t]=this.orange,this.fruitType[t]="orange"):(this.pic[t]=this.blue,this.fruitType[t]="blue")},check:function(){for(var t=0,i=0;i<this.num;i++)this.alive[i]&&t++;if(t<15)return void this.sendFruit()},sendFruit:function(){for(var t=0;t<this.num;t++)if(!this.alive[t]){this.born(t);break}},dead:function(t){this.alive[t]=!1}},AneObj.prototype={constructor:AneObj,num:50,init:function(){for(var t=0;t<this.num;t++)this.startPointX[t]=20*t+20*Math.random()-100,this.endPointX[t]=this.startPointX[t],this.endPointY[t]=canHeight-250+50*Math.random(),this.amplitude[t]=50*Math.random()+70},draw:function(){this.alpha+=.001*deltaTime,this.sine=Math.sin(this.alpha),ctxBg.save(),ctxBg.globalAlpha=.6,ctxBg.lineWidth=20,ctxBg.lineCap="round",ctxBg.strokeStyle="#3b154e";for(var t=0;t<this.num;t++)this.endPointX[t]=this.startPointX[t]+this.sine*this.amplitude[t],ctxBg.beginPath(),ctxBg.moveTo(this.startPointX[t],this.startPointY),ctxBg.quadraticCurveTo(this.startPointX[t],canHeight-50,this.endPointX[t],this.endPointY[t]),ctxBg.stroke();ctxBg.restore()}};var DataObj=function(){this.fruitNum=0,this["double"]=1,this.score=0,this.gameOver=!1,this.alpah=0};DataObj.prototype={constructor:DataObj,reset:function(){this.fruitNum=0,this["double"]=1},draw:function(){ctxFish.save(),ctxFish.shadowBlur=10,ctxFish.shadowColor="white",ctxFish.fillText("当前收集果实 "+this.fruitNum,canWidth/2,canHeight-50),2==this["double"]&&ctxFish.fillText("当前喂养分数翻倍 ",canWidth/2,canHeight-80),ctxFish.fillText("SCORE "+this.score,canWidth/2,80),data.gameOver&&(this.alpah+=.001*deltaTime,this.alpah>1&&(this.alpah=1),ctxFish.fillStyle="rgba(255,255,255,"+this.alpah+")",ctxFish.fillText("GAMEOVER",canWidth/2,canHeight/2)),ctxFish.restore()},addScore:function(){this.score+=100*this.fruitNum*this["double"],this.reset()}},extend(WaveObj.prototype,{constructor:WaveObj,num:10,init:function(){for(var t=0;t<this.num;t++)this.alive[t]=fasle,this.radius[t]=0},draw:function(){ctxFish.save(),ctxFish.lineWidth=2,ctxFish.shadowBlur=10,ctxFish.shadowColor="white";for(var t=0;t<this.num;t++)if(this.alive[t]){if(this.radius[t]+=.1*deltaTime,this.radius[t]>this.maxRadius){this.alive[t]=!1;break}var i=1-this.radius[t]/this.maxRadius;ctxFish.beginPath(),ctxFish.arc(this.x[t],this.y[t],this.radius[t],0,2*Math.PI),ctxFish.closePath(),ctxFish.strokeStyle="rgba("+this.color+","+i+")",console.log(),ctxFish.stroke()}ctxFish.restore()},born:function(t,i){for(var e=0;e<this.num;e++)if(!this.alive[e])return this.x[e]=t,this.y[e]=i,this.radius[e]=10,void(this.alive[e]=!0)}});var DustObj=function(t){extend(this,t),this.baseX=[],this.x=[],this.y=[],this.amplitude=[],this.type=[],this.alpha=0,this.num=30,this.init()};extend(DustObj.prototype,{init:function(){for(var t=0;t<7;t++)dustPicArr[t]=new Image,dustPicArr[t].src="./images/dust/dust"+t+".png";for(var t=0;t<this.num;t++)this.baseX[t]=Math.random()*canWidth,this.y[t]=Math.random()*canHeight,this.amplitude[t]=30+15*Math.random(),this.type[t]=dustPicArr[Math.floor(7*Math.random())]},draw:function(){this.alpha+=.001*deltaTime,this.sine=Math.sin(this.alpha),ctxBg.save();for(var t=0;t<this.num;t++)this.x[t]=this.baseX[t]+this.sine*this.amplitude[t],ctxBg.drawImage(this.type[t],this.x[t],this.y[t]);ctxBg.restore()}});